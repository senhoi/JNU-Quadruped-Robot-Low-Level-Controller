# Readme

## 工程描述
该工程为JNU四足项目的底层控制器（low-level controller）测试工程。意图实现带有前馈的串级PID控制，为实现力/力位混合控制打下铺垫。该项目目前针对INNFOS系列执行器开发，采用了SCA的API接口，但由于模块化的程序设计，无需任何改动便可以将控制部分移植到其他系列执行器上（如RM3508/RM2006等直流电动机）

## 文件结构
该工程实现了针对INNFOS电机的串级PID控制，主要文件包括
* /APP
  * motor.c         电机控制器算法实现（带有前馈的串级PID）
  * motor.h
  * pid.c           底层PID算法实现，包括位置式PID及增量式PID，其中位置式PID具有抗积分饱和功能
  * pid.h       
* /CORE
  * ...
* /FWLIB
  * ...
* /HARDWARE
  * ...
* /OBJ
  * ...
* /SCA
  * SCA_API.c       INNFOS SCA API接口
  * SCA_API.h
  * SCA_APP.c       INNFOS SCA 测试应用程序
  * SCA_APP.h
  * SCA_Protocol.c  INNFOS SCA 通讯协议层
  * SCA_Protocol.h
* /SYSTEM
  * ...
* /USER
  * main.c          程序执行入口
  * tasks.c         前后台任务
  * tasks.h
  * ...

## 测试计划
> ### 1. 新版SCA官方SDK程序验证
> 
> #### 需测试文件：
> - /HARDWARE/CAN/can.c
> 
> #### 测试描述：
> 新版官方SDK实现了上位机的全部功能，可以在单片机上实现与使用上位机等效的各种操作。新SDK使用了两个CAN接口（CAN1，CAN2），基于STM32F429开发。测试内容为将原有适配于F429的can.c程序，修改为基于STM32F407的两路can通讯程序。
> 
> #### 测试方法：
> 修改can.c，使之适配STM32F07，将一个电机ID通过上位机修改为ID1，连接到CAN1，另外两个电机ID通过上位机修改为ID2、ID3，连接到CAN2。复位开发板，观察电机指示灯是否可以由黄变绿。
> 
> #### 测试成功标志：
> CAN1及CAN2总线上的电机都能够成功开机
> #### 预计耗时：15 - 30 min

> ### 2. 串级PID控制算法测试
> 
> #### 需测试文件：
> - /APP/motor.c
> - /APP/pid.c
> 
> #### 测试描述：
> 当前为第3版PID算法，优化了程序结构，去掉了无用的功能。增加了前馈控制，进而实现了速度位置、速度电流、位置电流、速度位置电流等新模式。需要测试内容主要有：PID基础算法测试，PID输出限幅测试、位置PID抗积分饱和测试、串级控制器前馈控制
> 
> #### 测试方法：
> 首先测试PID基础算法：将电机初始化为位置模式：
> ~~~c
> MOTOR_init(&SCA[0], MOTOR_POSITION_MODE);
> ~~~
> 设置速度环与位置环增益（先只修改Kp）
> ~~~c
> MOTOR_set_vel_loop_gain(&SCA[0], 1.0f, 0.0f);
> MOTOR_set_pos_loop_gain(&SCA[0], 1.0f, 0.0f, 0.0f);
> ~~~
> 调用位置模式函数
> ~~~c
> int MOTOR_pos_mode(MOTOR_t* motor, float position);
> ~~~
> 观察是否能够修改此函数位置参数，以调节电机位置
> 
> 之后通过串口打印读取到的电机实际位置，与位置指令值进行比较，修改ki、kd等参数，实现电机位置准确控制（实际上通过Jlink调式读取电机的实时参数更加方便）
>
>此后，修改电机的位置环输出限幅（限制电机最高速度，并是限制电机位置，限制电机位置的方法依然是设置电机内部的位置限制参数），观察位置模式下阶跃响应是否发生变化
> ~~~c
> MOTOR_set_vel_loop_limit(&SCA[0], 0.0f, 0.0f);
> MOTOR_set_pos_loop_limit(&SCA[0], 0.0f, 0.0f);
> ~~~
> 抗积分饱和测试和串级控制器前馈控制较为复杂，并且需要在保证前两个测试成功的基础上方能测试。暂且不论。
> #### 测试成功标志：
> 成功实现电机位置的准确控制
> #### 预计耗时：1h - 3h

> ### 3. 控制频率测试
> 
> #### 需测试文件：
> - /USER/tasks.c
> 
> #### 测试描述：
> 对于数字控制而言，控制频率至关重要。目前电机参数的获取、PID计算、控制指令的发送都是放在后台程序中执行的，通过这种方式可以方便的测试出单片机对电机的控制频率
> 
> #### 测试方法：
> 观察串口输出，输出为3秒内控制频率的平均值
> 
> #### 预计耗时：5 min

